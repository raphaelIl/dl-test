services:
  grab-video:
    build: .
    image: raphael1021/dl-test:latest
#    image: ${DOCKER_HUB_USER}/${IMAGE_NAME}:${VERSION}
    container_name: grab-video
    restart: always
    ports:
      - "80:5000"
    volumes:
      - ./downloads:/app/downloads
      - ./logs:/app/logs
      - ./download_stats.json:/app/download_stats.json
    environment:
      - DOWNLOAD_FOLDER=downloads
      - MAX_FILE_SIZE_MB=2048
      - GUNICORN_WORKERS=3
      - GUNICORN_THREADS=4
      - MAX_WORKERS=2
      - STATUS_MAX_AGE=1800
      - STATUS_CLEANUP_INTERVAL=60
#      - DOWNLOAD_LIMITS=60 per 5 minutes
      - DOWNLOAD_LIMITS=30 per minute
      - TZ=Asia/Seoul
      - PYTHONUNBUFFERED=1
      - ALLOWED_HEALTH_IPS=127.0.0.1,125.177.83.187,172.16.0.0/12,192.168.0.0/16
      - GUNICORN_LOG_LEVEL=error
      - GUNICORN_ACCESS_LOGFILE=None # GUNICORN_ACCESS_LOGFILE=/app/logs/access.log
#      - GUNICORN_ACCESS_LOG_FORMAT=%(h)s %(l)s %(u)s %(t)s "%(r)s" %(s)s %(b)s %(L)s
      - GUNICORN_ERROR_LOGFILE=/app/logs/error.log
      - IP_HIDE_MODE=true
    logging:
      driver: "json-file"
      options:
        max-size: "2m"
        max-file: "10"
    depends_on:
      - cloudflared

# https://one.dash.cloudflare.com/588918288e7fa323754ce6357381199f/networks/tunnels
# https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/configure-tunnels/cloudflared-parameters/run-parameters
# https://github.com/quic-go/quic-go/wiki/UDP-Buffer-Sizes
# https://github.com/cloudflare/cloudflared/issues/1176#issuecomment-2993329228
  cloudflared:
    image: cloudflare/cloudflared:latest-arm64 # https://hub.docker.com/r/cloudflare/cloudflared/tags
    container_name: cloudflared
    restart: always
    command: tunnel --proxy-connect-timeout 5m --proxy-tls-timeout 2m --proxy-tcp-keepalive 1m --proxy-keepalive-timeout 10m --grace-period 3m --no-autoupdate run --token ${DEVGRAB_CLOUDFLARED_TOKEN}
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
