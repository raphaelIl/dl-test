{% extends "base.html" %}

{% block title %}{{ _('다운로드 진행 중') }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/download_styles.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="language-selector">
        {% for code, name in languages.items() %}
        <a href="/{{ code }}{{ request.path[3:] if request.path|length > 3 else '/' }}"
           {% if current_lang == code %}class="active"{% endif %}>
            {{ name }}
        </a>
        {% endfor %}
    </div>

    <h1>{{ _('다운로드 진행 중') }}</h1>

    <div class="status-text" id="status-text">{{ _('다운로드가 진행 중입니다...') }}</div>

    <div class="spinner"></div>

    <div class="progress-container">
        <div class="progress-bar" id="progress-bar">
            <span class="progress-text" id="progress-text">0%</span>
        </div>
    </div>

    <p>{{ _('다운로드가 완료되면 자동으로 다음 페이지로 이동합니다.') }}</p>
    <a href="{{ url_for('index', lang=current_lang) }}" class="btn">
        <i class="fas fa-home"></i> {{ _('취소하고 메인으로 돌아가기') }}
    </a>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 주기적으로 상태 확인
    let checkStatusInterval;

    function checkStatus() {
        fetch('/{{ current_lang }}/check-status/{{ file_id }}')
            .then(response => response.json())
            .then(data => {
                const statusElement = document.getElementById('status-text');
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');

                if (data.status === 'downloading') {
                    statusElement.innerText = '{{ _('다운로드 중입니다...') }}';
                    progressBar.style.width = Math.min(data.progress, 100) + '%';
                    progressText.innerText = Math.round(data.progress) + '%';
                } else if (data.status === 'processing') {
                    statusElement.innerText = '{{ _('파일 처리 중입니다...') }}';
                    progressBar.style.width = '100%';
                    progressText.innerText = '100%';
                } else if (data.status === 'completed') {
                    statusElement.innerText = '{{ _('다운로드 완료! 이동 중...') }}';
                    progressBar.style.width = '100%';
                    progressText.innerText = '100%';
                    clearInterval(checkStatusInterval);
                    window.location.href = data.redirect;
                } else if (data.status === 'error') {
                    statusElement.innerText = '{{ _('다운로드 오류:') }} ' + (data.error || '{{ _('알 수 없는 오류') }}');
                    progressBar.style.backgroundColor = '#f44336';
                    progressBar.style.width = '100%';
                    clearInterval(checkStatusInterval);
                }
            })
            .catch(error => {
                console.error('{{ _('상태 확인 중 오류:') }}', error);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // 페이지 로드 시 즉시 상태 확인
        checkStatus();

        // 2초마다 상태 확인
        checkStatusInterval = setInterval(checkStatus, 2000);
    });
</script>
{% endblock %}
